const Database = require("better-sqlite3");
const path = require("path");

const db = new Database(path.join(__dirname, "matchpoint.sqlite"));
db.pragma("journal_mode = WAL");

db.exec(`
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  role TEXT NOT NULL CHECK(role IN ('player','venue')),
  created_at TEXT NOT NULL,

  level REAL NOT NULL DEFAULT 2.5,
  reliability_pct INTEGER NOT NULL DEFAULT 0
);

CREATE TABLE IF NOT EXISTS login_codes (
  email TEXT PRIMARY KEY,
  code TEXT NOT NULL,
  expires_at INTEGER NOT NULL
);

CREATE TABLE IF NOT EXISTS venues (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  owner_user_id INTEGER NOT NULL,
  name TEXT NOT NULL,
  city TEXT NOT NULL,
  area TEXT,
  phone TEXT,
  created_at TEXT NOT NULL,
  FOREIGN KEY (owner_user_id) REFERENCES users(id)
);

CREATE TABLE IF NOT EXISTS courts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  venue_id INTEGER NOT NULL,
  name TEXT NOT NULL,
  indoor INTEGER NOT NULL DEFAULT 0,
  price_per_hour INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL,
  FOREIGN KEY (venue_id) REFERENCES venues(id)
);

CREATE TABLE IF NOT EXISTS bookings (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  court_id INTEGER NOT NULL,
  starts_at TEXT NOT NULL, -- ISO string
  created_at TEXT NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (court_id) REFERENCES courts(id)
);

-- Doubles only: match has 4 players total, split into Team A (2) and Team B (2)
CREATE TABLE IF NOT EXISTS matches (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  host_user_id INTEGER NOT NULL,
  court_id INTEGER NOT NULL,
  title TEXT NOT NULL,
  skill TEXT NOT NULL,
  starts_at TEXT NOT NULL,
  need_players INTEGER NOT NULL, -- open spots remaining out of 3
  created_at TEXT NOT NULL,

  competitive INTEGER NOT NULL DEFAULT 1,
  status TEXT NOT NULL DEFAULT 'scheduled'
    CHECK(status IN ('scheduled','awaiting_feedback','finalized')),
  result_json TEXT,              -- { sets:[[a,b]...], winnerTeam:'A'|'B'|'tie' }
  feedback_deadline INTEGER,     -- unix ms
  finalized_at TEXT,

  FOREIGN KEY (host_user_id) REFERENCES users(id),
  FOREIGN KEY (court_id) REFERENCES courts(id)
);

CREATE TABLE IF NOT EXISTS match_players (
  match_id INTEGER NOT NULL,
  user_id INTEGER NOT NULL,
  team TEXT NOT NULL CHECK(team IN ('A','B')),
  PRIMARY KEY(match_id, user_id),
  FOREIGN KEY (match_id) REFERENCES matches(id),
  FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE TABLE IF NOT EXISTS player_feedback (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  match_id INTEGER NOT NULL,
  from_user_id INTEGER NOT NULL,
  about_user_id INTEGER NOT NULL,
  vote TEXT NOT NULL CHECK(vote IN ('higher','correct','lower')),
  created_at TEXT NOT NULL,

  UNIQUE(match_id, from_user_id, about_user_id),
  FOREIGN KEY (match_id) REFERENCES matches(id),
  FOREIGN KEY (from_user_id) REFERENCES users(id),
  FOREIGN KEY (about_user_id) REFERENCES users(id)
);
`);

module.exports = db;
